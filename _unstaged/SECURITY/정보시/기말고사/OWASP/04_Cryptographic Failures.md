# Cryptographic Failures
## 1. 배경 (Background)

- **순위**: OWASP Top 10:2025에서 A04는 2021년의 2위에서 **두 단계 하락해 4위**를 차지.
- **의미**: 암호화를 아예 사용하지 않거나, 약하거나 구식인 암호 알고리즘·프로토콜을 사용하거나, 암호 키를 유출·오관리한 결과로 발생하는 **암호 관련 전반의 실패**를 다룬다.
- **데이터 특성**:
    - 평균적으로 **3.80%의 애플리케이션**에서 이 카테고리의 CWE가 하나 이상 발견되며, 총 발생 건수는 **1,665,348건**, 관련 CVE는 **2,185개**로 집계됨.
    - 특히 네 개의 주요 CWE가 **취약한 난수 생성·PRNG 사용 문제**와 깊이 연관되어 있음 (예: CWE-327, CWE-331, CWE-1241, CWE-338).
- **핵심 포인트**:
    - “암호를 안 쓰는 것”뿐 아니라, 잘못된 알고리즘/모드 선택, 잘못된 난수·IV 사용, 키 하드코딩/저장소 유출, 암호화 미강제(TLS 미사용/미검증), 패스워드 해시/키 유도(PBKDF) 오용 등이 모두 **Cryptographic Failures** 범주에 포함된다.
- **대표 CWE** (A04 범주에 포함되는 대표적인 약점들):
    - **CWE-319** – Cleartext Transmission of Sensitive Information (민감 정보 평문 전송)
    - **CWE-321** – Use of Hard-coded Cryptographic Key (하드코딩된 암호 키 사용)
    - **CWE-326** – Inadequate Encryption Strength (불충분한 암호 강도)
    - **CWE-327** – Use of a Broken or Risky Cryptographic Algorithm (깨지거나 위험한 알고리즘 사용)
    - **CWE-331/338** – Insufficient Entropy / Cryptographically Weak PRNG (난수 엔트로피 부족·취약 PRNG)
    - **CWE-759/760/916** – 솔트/워크팩터 미흡한 패스워드 해시 사용

## 2. Score table (점수 표)

| 항목                     | 값         |
| ---------------------- | --------- |
| 매핑된 CWE 수              | 32        |
| 최대 발생률 (Max Incidence) | 13.77%    |
| 평균 발생률 (Avg Incidence) | 3.80%     |
| 최대 커버리지 (Max Coverage) | 100.00%   |
| 평균 커버리지 (Avg Coverage) | 47.74%    |
| 가중 평균 Exploit 점수       | 7.23      |
| 가중 평균 Impact 점수        | 3.90      |
| 총 발생 건수                | 1,665,348 |
| 총 CVE 수                | 2,185     |

정량 지표를 종합하면, **Cryptographic Failures는 상당히 자주 발견되고(평균 3.8%), 발생 건수와 CVE 수도 매우 많은 편이며, 악용 난이도(Exploit)와 영향(Impact)도 모두 높은 “대중적이면서도 파급력이 큰” 위험 영역**으로 볼 수 있습니다. 특히 전송/저장 구간 암호화, 키 관리, 난수·해시·패딩 선택 등 여러 층위의 실수가 하나로 묶여 있다는 점에서, 실제 시스템에서는 **여러 작은 설정·코드 실수가 합쳐져 큰 사고로 이어질 가능성**이 큽니다.

## 3. 위험 설명 (Description)

Cryptographic Failures는 **암호화가 필요한 데이터를 적절히 보호하지 못해 민감 정보 노출이나 시스템 침해로 이어지는 모든 상황**을 포괄합니다.

일반적으로는 다음과 같은 관점에서 문제를 볼 수 있습니다.
- **전송 데이터**: 기본적으로 모든 데이터는 **전송 계층(OSI 4계층)** 에서 안전한 암호화(TLS 등)를 적용
- **저장 데이터**: 민감 데이터(패스워드, 카드번호, 건강정보, 개인정보, 영업기밀 등)는 **저장 시 암호화**가 필요
- **추가 보호**: 규제(GDPR, PCI DSS 등) 대상 데이터는 **전송·저장 모두에서 추가 보호(추가 레이어 암호화, 제한된 접근 등)** 가 요구

1. **구식·약한 암호 알고리즘·프로토콜 사용**
    - 과거 코드나 기본 설정에서 **취약하거나 더 이상 권장되지 않는 알고리즘/프로토콜(예: MD5, SHA-1, 오래된 TLS 버전)을 계속 사용하는 경우**.
2. **키 관리·키 회전 부재**
    - 기본 키 그대로 사용, 키 길이가 부족하거나, **키 재사용·회전 미실시·수명 관리 부재** 등으로 키 수명·노출 리스크가 큰 경우.
3. **소스 코드·저장소에 키·시크릿 노출**
    - API 키, 비밀 키, 인증서 개인키 등을 **Git 저장소, 설정 파일, .env 파일 등에 그대로 커밋**하거나, 접근 통제가 약한 저장 위치에 두는 경우.
4. **전송 구간 암호화 미강제 / 브라우저 보안 헤더 미설정**
    - 모든 페이지에 대해 TLS(HTTPS)를 강제하지 않거나, `HSTS` 등 **브라우저 측 암호화 강제 헤더를 설정하지 않아** 다운그레이드나 중간자 공격에 취약한 경우.
5. **인증서 및 신뢰 체인 검증 미흡
    - 서버 인증서의 유효성, 체인, 호스트명 검증 등을 제대로 수행하지 않아, 사용자가 **위조 서버와의 암호화 연결을 “정상”으로 인식**하게 되는 경우.
6. **IV/Nonce·모드 운영 오류 (ECB, IV 재사용 등)**
    - 블록 암호 모드에 맞는 IV/Nonce 전략을 사용 X
    - IV를 반복 사용, 무작위성이 부족한 IV 사용
    - **ECB와 같이 구조가 노출되는 모드를 그대로 사용**
7. **패스워드를 직접 키로 사용 (PBKDF 미사용)**
    - 패스워드를 키로 사용하면서 **패스워드 기반 키 유도 함수(PBKDF: Argon2, scrypt, PBKDF2 등)를 사용하지 않고 바로 사용하는 경우**.
8. **암호용이 아닌 난수·시드 사용 (엔트로피 부족)**
    - 임의 값 생성에 **일반 난수 함수나 낮은 엔트로피 소스**를 사용
    - CSPRNG의 안전한 시드를 덮어쓰거나, 반복된 시드를 사용하는 등으로 **예측 가능한 난수**를 만드는 경우.
9. **비암호화 해시·더 이상 권장되지 않는 해시 사용**
    - 암호 목적에 맞지 않는 해시 함수 사용
    - **MD5, SHA-1 등 이미 취약성이 입증된 해시 함수 사용**.
10. **취약한 패딩·패딩 오라클 가능성**
    - PKCS #1 v1.5 같은 **취약한 패딩 스킴**이나, 에러 메시지나 응답 시간 차이 등으로 패딩 오라클을 유발하는 구현.
11. **알고리즘 다운그레이드·우회 가능**
    - 협상 중 덜 안전한 암호 알고리즘으로 **강제 다운그레이드가 가능한 구성(CWE-757)** 이나, 암호화 자체를 우회하는 경로가 존재.
12. **암호화 에러·사이드 채널 정보 노출**
    - 에러 메시지·시간 차·메모리 사용 패턴 등 **사이드 채널을 통해 키·평문에 대한 추가 정보가 노출되는 구현.**

## 4. 예방 방법 (How to prevent)

1. **데이터 분류·레이블링**
    - 애플리케이션이 처리·저장·전송하는 데이터를 분류
    - 법·규제(GDPR, PCI DSS 등) 및 비즈니스 관점에서 **어떤 데이터가 “민감 데이터”인지 명확히 정의·레이블링**한다.
2. **키 관리 체계 수립 및 HSM 활용**
    - 가장 민감한 키는 가능하면 **HSM(하드웨어 보안 모듈) 또는 클라우드 HSM/키 관리 서비스**에 저장.
    - 키 생성·회전·폐기·백업·사용 권한을 정책으로 정의하고, 자동화 도구로 강제한다.
3. **검증된 암호 라이브러리 사용**
    - 직접 알고리즘을 구현 X
    - **검증된 표준 라이브러리·프레임워크**를 사용하며, OS/플랫폼 제공 Crypto API를 우선적으로 활용한다.
4. **민감 데이터 최소 수집·저장**
    - 필요 이상으로 민감 데이터를 저장 X
    - 가능하면 **토큰화·마스킹·Truncation**을 사용한다.
    - “가지고 있지 않은 데이터는 탈취될 수 없다”는 원칙을 따른다.
5. **민감 데이터 저장 시 암호화 적용**
    - 디스크·DB·백업 등 저장 매체에 **민감 데이터는 반드시 암호화된 형태**로 저장.
    - 단순 “디스크 암호화”에만 의존하지 말고, 애플리케이션 레벨에서도 필요한 경우 추가적으로 암호화.
6. **전송 구간 암호화(TLS) 강제 및 보안 설정**
    - 모든 전송 구간에 대해 **TLS(Forward Secrecy 지원, 안전한 Cipher Suite, 서버 우선 Cipher 선택 등)** 사용.
    - `HSTS`와 같은 헤더를 통해 **HTTPS를 강제**하고, 중간자 공격·다운그레이드 공격을 방지한다.
7. **민감 응답 데이터 캐싱 금지**
    - 민감 데이터를 포함하는 응답은 CDN, 웹 서버, 애플리케이션 캐시(예: Redis) 등에서 **캐시되지 않도록 설정**한다.
8. **데이터 분류에 따른 보안 통제 적용**
    - 앞서 정의한 데이터 분류에 맞게 암호화 강도, 키 관리 요구사항, 접근 통제, 로깅 레벨 등을 **등급별로 다르게 적용**한다.
9. **비암호화 프로토콜 사용 금지**
    - FTP, SMTP(평문), Telnet 등 **암호화되지 않은 프로토콜 사용을 지양**
    - 필요시 FTPS/SFTP, SMTPS/STARTTLS 등 암호화된 대체 프로토콜을 사용.
10. **강력한 패스워드 해시 사용**
    - 패스워드는 **Argon2, scrypt, bcrypt(레거시), PBKDF2-HMAC-SHA-256** 등 **적응형(Adaptive)·솔트+워크팩터를 가진 해시 함수**로 저장한다.
11. **올바른 IV/Nonce 전략 및 인증 암호(AE)**
    - 사용 모드에 맞게 IV/Nonce를 생성하고, **같은 키로 같은 IV를 재사용하지 않도록** 설계한다.
    - 가능하면 **Authenticated Encryption(AEAD: AES-GCM 등)** 을 사용해 무결성까지 동시에 보호한다.
12. **키 생성·저장·PW → Key 변환 모범 사례 준수**
    - 키는 CSPRNG로 생성하고, 메모리에서는 **바이트 배열 형태**로 다루며 필요 이상 오래 보관하지 않는다.
    - 비밀번호를 키로 사용할 경우 반드시 PBKDF를 통해 키를 유도한다.
13. **난수·엔트로피 관리**
    - 암호에 사용하는 난수는 **CSPRNG를 사용**
    - 개발자가 별도로 시드를 설정할 필요가 없다면 건드리지 않는다(내부 엔트로피 수집 기능을 신뢰).
14. **구식 알고리즘·패딩·모드 지양**
    - MD5, SHA-1, CBC(특히 잘못된 패딩), PKCS #1 v1.5 등 **더 이상 권장되지 않는 컴비네이션을 사용하지 않도록** 코드를 점검·정리한다.
15. **암호 설정·구성을 주기적으로 리뷰**
    - 암호 설정·키 관리 정책·지원 Cipher Suite·TLS 버전·해시 함수·PBKDF 파라미터 등을     **전문가 리뷰 및 자동화 도구**를 통해 주기적으로 검증한다.
16. **양자 내성(Post-Quantum Cryptography) 대비**
    - ENISA·NIST 등에서 제공하는 PQC 로드맵·표준을 참고
    - 장기 보관이 필요한 데이터·키에 대해 **양자 컴퓨팅 시대를 고려한 암호 설계**를 준비한다.

## 5. 예시 공격 시나리오 (Example attack scenarios)
### 시나리오 1 – TLS 미사용·약한 암호화로 인한 세션 하이재킹

어떤 웹 사이트는 로그인 페이지에서는 HTTPS를 사용하지만, 로그인 이후의 일부 페이지는 여전히 **HTTP로 접근이 가능**합니다. 또한 서버 설정도 약한 암호 스위트와 구식 TLS 버전을 허용하고 있습니다.
공격자는 공용 와이파이 같은 **신뢰할 수 없는 네트워크 구간에서 트래픽을 패킷 스니핑·중간자 공격**으로 감시하면서, 사용자의 접속을 HTTPS에서 HTTP로 강제로 다운그레이드하거나, 암호화가 약한 세션을 가로챕니다.  
이 과정에서 **세션 쿠키를 탈취**한 공격자는 해당 쿠키를 재사용해 사용자의 로그인 상태를 그대로 재현하고, 사용자 계정으로 민감 정보 조회, 설정 변경, 심지어 송금 수신자를 바꾸는 등의 행위를 수행할 수 있습니다.

### 시나리오 2 – 솔트 없는 단순 해시 기반 패스워드 저장소 탈취

한 서비스는 사용자 비밀번호를 “암호화했다”고 주장하지만, 실제로는 **솔트 없이 단순 해시(SHA-1 또는 MD5 등)만 적용**해 DB에 저장하고 있습니다.  
또 다른 취약점(예: 파일 업로드 취약점, SQL Injection 등)을 통해 공격자가 이 패스워드 DB를 덤프해 가져가는 데 성공합니다.
공격자는 공개된 **레인보우 테이블**과 GPU를 활용한 오프라인 크래킹을 통해 짧은 시간 안에 다수의 패스워드를 평문으로 복원합니다.  
이 중 상당수는 **다른 서비스에서도 재사용되는 패스워드**이기 때문에, 공격자는 동일 이메일·ID를 이용해 여러 서비스에서 계정을 탈취하고 2차 피해를 확산시킵니다.

---

## 참고

- [OWASP Foundation – A04:2025 Cryptographic Failures](https://owasp.org/Top10/2025/A04_2025-Cryptographic_Failures/ "A04 Cryptographic Failures - OWASP Top 10:2025")   