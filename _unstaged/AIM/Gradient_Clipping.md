# Gradient Clipping
## 1. 기본 정의

**Gradient Clipping(그래디언트 클리핑)**: **기울기(gradient)의 크기가 너무 커지는 것(기울기 폭발)** 을 방지하기 위해 기울기의 **크기(norm)** 를 일정 한도 이하로 잘라내는(clipping) 기법이다.

“기울기가 너무 커져서 학습이 불안정해질 때, 그 크기를 일정 범위로 제한하는 방법”

---

## 2. 왜 필요한가? — “기울기 폭발(Exploding Gradient)” 문제

신경망의 학습 과정에서는 역전파(Backpropagation)를 통해 각 파라미터의 기울기(gradient)가 계산된다.

그런데
- **네트워크가 깊거나**,
- **RNN처럼 시퀀스 길이가 길 때**,
- **Loss surface가 급격히 변할 때**
기울기가 **지수적으로 커질 수 있다**

결과적으로:

|문제|현상|
|---|---|
|**Exploding Gradient**|가중치가 한 번에 너무 크게 업데이트됨|
|**결과**|손실이 발산, 학습 불안정, NaN 발생|

---

## 3. 핵심 아이디어

“기울기의 방향은 유지하되, 크기가 너무 클 때는 일정 한도로 줄인다.”

- 크기가 정상적이면 그대로 둠    
- 너무 크면 정규화(normalize)해서 제한

---

## 4. 수식 표현

현재 gradient: $g$
허용 최대 크기: $threshold$ 또는 $clipvalue$

$$\text{if } |g|_2 > \text{threshold:} \quad g = \frac{threshold}{|g|_2} \cdot g$$

| 기호          | 의미                              |
| ----------- | ------------------------------- |
| $\|g\|_2$   | gradient의 L2 노름 (크기)            |
| $threshold$ | 허용할 최대 크기 (보통 1~5 사이)           |
| $g$         | 스케일링된 gradient (방향은 동일, 크기만 줄임) |

“너무 큰 gradient는 방향은 그대로 두고, 길이만 잘라낸다.”

---

## 6. Gradient Clipping의 종류

| 종류                    | 설명                                           |
| --------------------- | -------------------------------------------- |
| **Norm Clipping**     | 전체 gradient 벡터의 L2 norm이 threshold를 넘으면 스케일링 |
| **Value Clipping**    | gradient의 각 원소별로 절대값을 제한                     |
| **Adaptive Clipping** | 파라미터별로 다른 한도를 적용                             |
실무에서는 거의 항상 **L2-Norm Clipping** 을 사용한다.

---

## 7. Clipping의 효과

|항목|효과|
|---|---|
|**학습 안정성 향상**|기울기 폭발 방지|
|**NaN 손실 방지**|계산 overflow 방지|
|**RNN, LSTM 학습 필수**|긴 시퀀스에서도 학습 유지|
|**최적화 안정화**|learning rate가 조금 커도 견딜 수 있음|

---

## 8. Clipping 값 선택 (Threshold)

일반적인 값 범위:

| 모델 유형                 | Threshold 값         |
| --------------------- | ------------------- |
| **RNN / LSTM**        | 1.0 ~ 5.0           |
| **CNN / Transformer** | 0.5 ~ 2.0           |
| **대규모 모델**            | 0.1 ~ 1.0 (정규화 강하게) |

너무 작게 설정하면 학습이 느려지고, 너무 크게 설정하면 여전히 폭발 위험이 있다.
보통 경험적으로 **clip_norm = 1~5** 로 충분하다.