# Message Authentication Code, MAC 검증

## 1. 기본 원리

- 송신자: **공유 키 K**로 `tag = MAC(K, message)` 생성 후 `(message, tag)` 전송
- 수신자: **동일 K**로 `tag' = MAC(K, message)` 다시 계산 → **상수시간 비교**로 `tag' == tag` 확인
- 통과하면 **무결성 + 인증** 보장(발신자가 K를 아는 자임을 증명)

## 2. 표준 MAC 종류

- **HMAC**(SHA-256 등): 가장 널리 사용
- **CMAC**(AES 기반), **GMAC**(AES-GCM의 MAC), **Poly1305**(ChaCha20-Poly1305의 MAC)

## 3. 안전한 검증 절차 (체크리스트)

1. **정확한 바이트열**로 검증
    - 직렬화/인코딩 통일(JSON canonicalize, 공백/정렬 고정)
2. **상수시간 비교** 사용
    - 시간을 통해 tag의 일치 정도가 새지 않도록
3. **키 분리**
    - `K_enc`(암호화)와 `K_mac`(MAC) **별도** 사용 (또는 **AEAD** 채택)
4. **재전송/재사용 방지**
    - 메시지에 **nonce/시퀀스/타임스탬프** 포함 후 MAC에 함께 포함
5. **컨텍스트 바인딩**
    - 프로토콜 버전, 목적지, 메소드(HTTP verb), 경로 등 **부가데이터(AAD)**를 MAC에 포함
6. **태그 길이 충분히**
    - HMAC-SHA-256은 보통 **16바이트 이상** 권장(보통 32바이트 그대로)
7. **에러 처리 단순화**
    - “검증 실패”만 반환(원인 세분화 금지) + 상수시간 경로